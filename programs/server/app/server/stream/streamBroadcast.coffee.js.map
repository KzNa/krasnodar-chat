{"version":3,"sources":["meteor://ðŸ’»app/server/stream/streamBroadcast.coffee"],"names":[],"mappings":"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","file":"/server/stream/streamBroadcast.coffee.js","sourcesContent":["logger = new Logger 'StreamBroadcast',\n\tsections:\n\t\tconnection: 'Connection'\n\t\tauth: 'Auth'\n\t\tstream: 'Stream'\n\n\nauthorizeConnection = (connection, record) ->\n\tlogger.auth.info \"Authorizing with localhost:#{record.extraInformation.port}\"\n\tconnection.call 'broadcastAuth', record._id, InstanceStatus.id(), (err, ok) ->\n\t\tconnection.broadcastAuth = ok\n\t\tlogger.auth.info \"broadcastAuth with localhost:#{record.extraInformation.port}\", ok\n\n@connections = {}\n@startStreamBroadcast = (streams) ->\n\tlogger.info 'startStreamBroadcast'\n\n\t# connections = {}\n\n\tInstanceStatus.getCollection().find({'extraInformation.port': {$exists: true}}, {sort: {_createdAt: -1}}).observe\n\t\tadded: (record) ->\n\t\t\tif record.extraInformation.port is process.env.PORT or connections[record.extraInformation.port]?\n\t\t\t\treturn\n\n\t\t\tlogger.connection.info 'connecting in', \"localhost:#{record.extraInformation.port}\"\n\t\t\tconnections[record.extraInformation.port] = DDP.connect(\"localhost:#{record.extraInformation.port}\", {_dontPrintErrors: true})\n\t\t\tauthorizeConnection(connections[record.extraInformation.port], record);\n\t\t\tconnections[record.extraInformation.port].onReconnect = ->\n\t\t\t\tauthorizeConnection(connections[record.extraInformation.port], record);\n\n\t\tremoved: (record) ->\n\t\t\tif connections[record.extraInformation.port]? and not InstanceStatus.getCollection().findOne({'extraInformation.port': record.extraInformation.port})?\n\t\t\t\tlogger.connection.info 'disconnecting from', \"localhost:#{record.extraInformation.port}\"\n\t\t\t\tconnections[record.extraInformation.port].disconnect()\n\t\t\t\tdelete connections[record.extraInformation.port]\n\n\tbroadcast = (streamName, args, userId) ->\n\t\tfor port, connection of connections\n\t\t\tdo (port, connection) ->\n\t\t\t\tif connection.status().connected is true\n\t\t\t\t\tconnection.call 'stream', streamName, args, (error, response) ->\n\t\t\t\t\t\tif error?\n\t\t\t\t\t\t\tlogger.error \"Stream broadcast error\", error\n\n\t\t\t\t\t\tswitch response\n\t\t\t\t\t\t\twhen 'self-not-authorized'\n\t\t\t\t\t\t\t\tlogger.stream.error \"Stream broadcast from:#{process.env.PORT} to:#{connection._stream.endpoint} with name #{streamName} to self is not authorized\".red\n\t\t\t\t\t\t\t\tlogger.stream.debug \"    -> connection authorized\".red, connection.broadcastAuth\n\t\t\t\t\t\t\t\tlogger.stream.debug \"    -> connection status\".red, connection.status()\n\t\t\t\t\t\t\t\tlogger.stream.debug \"    -> arguments\".red, args\n\n\t\t\t\t\t\t\twhen 'not-authorized'\n\t\t\t\t\t\t\t\tlogger.stream.error \"Stream broadcast from:#{process.env.PORT} to:#{connection._stream.endpoint} with name #{streamName} not authorized\".red\n\t\t\t\t\t\t\t\tlogger.stream.debug \"    -> connection authorized\".red, connection.broadcastAuth\n\t\t\t\t\t\t\t\tlogger.stream.debug \"    -> connection status\".red, connection.status()\n\t\t\t\t\t\t\t\tlogger.stream.debug \"    -> arguments\".red, args\n\n\t\t\t\t\t\t\twhen 'stream-not-exists'\n\t\t\t\t\t\t\t\tlogger.stream.error \"Stream broadcast from:#{process.env.PORT} to:#{connection._stream.endpoint} with name #{streamName} does not exists\".red\n\t\t\t\t\t\t\t\tlogger.stream.debug \"    -> connection authorized\".red, connection.broadcastAuth\n\t\t\t\t\t\t\t\tlogger.stream.debug \"    -> connection status\".red, connection.status()\n\t\t\t\t\t\t\t\tlogger.stream.debug \"    -> arguments\".red, args\n\n\n\tMeteor.methods\n\t\tshowConnections: ->\n\t\t\tdata = {}\n\t\t\tfor port, connection of connections\n\t\t\t\tdata[port] =\n\t\t\t\t\tstatus: connection.status()\n\t\t\t\t\tbroadcastAuth: connection.broadcastAuth\n\t\t\treturn data\n\n\temitters = {}\n\n\tfor streamName, stream of streams\n\t\tdo (streamName, stream) ->\n\t\t\temitters[streamName] = stream.emitToSubscriptions\n\t\t\tstream.emitToSubscriptions = (args, subscriptionId, userId) ->\n\t\t\t\tif subscriptionId isnt 'broadcasted'\n\t\t\t\t\tbroadcast streamName, args\n\n\t\t\t\temitters[streamName] args, subscriptionId, userId\n\n\tMeteor.methods\n\t\tbroadcastAuth: (selfId, remoteId) ->\n\t\t\tcheck selfId, String\n\t\t\tcheck remoteId, String\n\n\t\t\t@unblock()\n\t\t\tif selfId is InstanceStatus.id() and remoteId isnt InstanceStatus.id() and InstanceStatus.getCollection().findOne({_id: remoteId})?\n\t\t\t\t@connection.broadcastAuth = true\n\n\t\t\treturn @connection.broadcastAuth is true\n\n\t\tstream: (streamName, args) ->\n\t\t\t# Prevent call from self and client\n\t\t\tif not @connection?\n\t\t\t\treturn 'self-not-authorized'\n\n\t\t\t# Prevent call from unauthrorized connections\n\t\t\tif @connection.broadcastAuth isnt true\n\t\t\t\treturn 'not-authorized'\n\n\t\t\tif not emitters[streamName]?\n\t\t\t\treturn 'stream-not-exists'\n\n\t\t\temitters[streamName].call null, args, 'broadcasted'\n\n\t\t\treturn undefined\n\n\nMeteor.startup ->\n\tconfig =\n\t\t'RocketChat.Notifications.streamAll': RocketChat.Notifications.streamAll\n\t\t'RocketChat.Notifications.streamRoom': RocketChat.Notifications.streamRoom\n\t\t'RocketChat.Notifications.streamUser': RocketChat.Notifications.streamUser\n\n\tstartStreamBroadcast config\n"]}