{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_assets/server/assets.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_assets.js","sourcesContent":["sizeOf = Npm.require 'image-size'\nmime = Npm.require 'mime-types'\n\nmime.extensions['image/vnd.microsoft.icon'] = ['ico']\n\n@RocketChatAssetsInstance = new RocketChatFile.GridFS\n\tname: 'assets'\n\n\nassets =\n\t'logo':\n\t\tlabel: 'logo (svg, png)'\n\t\tdefaultUrl: 'images/logo/logo.svg?v=3'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['svg', 'png']\n\t\t\twidth: undefined\n\t\t\theight: undefined\n\t'favicon.ico':\n\t\tlabel: 'favicon.ico'\n\t\tdefaultUrl: 'favicon.ico?v=3'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['ico']\n\t\t\twidth: undefined\n\t\t\theight: undefined\n\t'favicon.svg':\n\t\tlabel: 'favicon.svg'\n\t\tdefaultUrl: 'images/logo/icon.svg?v=3'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['svg']\n\t\t\twidth: undefined\n\t\t\theight: undefined\n\t'favicon_64.png':\n\t\tlabel: 'favicon.png (64x64)'\n\t\tdefaultUrl: 'images/logo/favicon-64x64.png?v=3'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 64\n\t\t\theight: 64\n\t'favicon_96.png':\n\t\tlabel: 'favicon.png (96x96)'\n\t\tdefaultUrl: 'images/logo/favicon-96x96.png?v=3'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 96\n\t\t\theight: 96\n\t'favicon_128.png':\n\t\tlabel: 'favicon.png (128x128)'\n\t\tdefaultUrl: 'images/logo/favicon-128x128.png?v=3'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 128\n\t\t\theight: 128\n\t'favicon_192.png':\n\t\tlabel: 'favicon.png (192x192)'\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png?v=3'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 192\n\t\t\theight: 192\n\t'favicon_256.png':\n\t\tlabel: 'favicon.png (256x256)'\n\t\tdefaultUrl: 'images/logo/favicon-256x256.png?v=3'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 256\n\t\t\theight: 256\n\n\nRocketChat.settings.addGroup 'Assets'\nfor key, value of assets\n\tRocketChat.settings.add \"Assets_#{key}\", '', { type: 'asset', group: 'Assets', fileConstraints: value.constraints, i18nLabel: value.label, asset: key }\n\n\nMeteor.methods\n\tunsetAsset: (asset) ->\n\t\tunless Meteor.userId()\n\t\t\tthrow new Meteor.Error 'invalid-user', \"[methods] unsetAsset -> Invalid user\"\n\n\t\thasPermission = RocketChat.authz.hasPermission Meteor.userId(), 'manage-assets'\n\t\tunless hasPermission\n\t\t\tthrow new Meteor.Error 'manage-assets-not-allowed', \"[methods] unsetAsset -> Manage assets not allowed\"\n\n\t\tif not assets[asset]?\n\t\t\tthrow new Meteor.Error \"Invalid_asset\"\n\n\t\tRocketChatAssetsInstance.deleteFile asset\n\t\tRocketChat.settings.clearById \"Assets_#{asset}\"\n\n\nMeteor.methods\n\tsetAsset: (binaryContent, contentType, asset) ->\n\t\tunless Meteor.userId()\n\t\t\tthrow new Meteor.Error 'invalid-user', \"[methods] setAsset -> Invalid user\"\n\n\t\thasPermission = RocketChat.authz.hasPermission Meteor.userId(), 'manage-assets'\n\t\tunless hasPermission\n\t\t\tthrow new Meteor.Error 'manage-assets-not-allowed', \"[methods] unsetAsset -> Manage assets not allowed\"\n\n\t\tif not assets[asset]?\n\t\t\tthrow new Meteor.Error \"Invalid_asset\"\n\n\t\tif mime.extension(contentType) not in assets[asset].constraints.extensions\n\t\t\tthrow new Meteor.Error \"Invalid_file_type\", contentType\n\n\t\tfile = new Buffer(binaryContent, 'binary')\n\n\t\tif assets[asset].constraints.width? or assets[asset].constraints.height?\n\t\t\tdimensions = sizeOf file\n\n\t\t\tif assets[asset].constraints.width? and assets[asset].constraints.width isnt dimensions.width\n\t\t\t\tthrow new Meteor.Error \"Invalid_file_width\"\n\n\t\t\tif assets[asset].constraints.height? and assets[asset].constraints.height isnt dimensions.height\n\t\t\t\tthrow new Meteor.Error \"Invalid_file_height\"\n\n\t\trs = RocketChatFile.bufferToStream file\n\t\tRocketChatAssetsInstance.deleteFile asset\n\t\tws = RocketChatAssetsInstance.createWriteStream asset, contentType\n\t\tws.on 'end', Meteor.bindEnvironment ->\n\t\t\tMeteor.setTimeout ->\n\t\t\t\tRocketChat.settings.updateById \"Assets_#{asset}\", \"/assets/#{asset}\"\n\t\t\t, 200\n\n\t\trs.pipe ws\n\t\treturn\n\n\nWebApp.connectHandlers.use '/assets/', Meteor.bindEnvironment (req, res, next) ->\n\tparams =\n\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, ''))\n\n\tfile = RocketChatAssetsInstance.getFileWithReadStream params.asset\n\n\t# res.setHeader 'Content-Disposition', 'inline'\n\n\tif not file?\n\t\tif assets[params.asset]?.defaultUrl?\n\t\t\tres.writeHead 301,\n\t\t\t\tLocation: Meteor.absoluteUrl(assets[params.asset].defaultUrl)\n\t\telse\n\t\t\tres.writeHead 404\n\t\tres.end()\n\t\treturn\n\n\treqModifiedHeader = req.headers[\"if-modified-since\"];\n\tif reqModifiedHeader?\n\t\tif reqModifiedHeader == file.uploadDate?.toUTCString()\n\t\t\tres.setHeader 'Last-Modified', reqModifiedHeader\n\t\t\tres.writeHead 304\n\t\t\tres.end()\n\t\t\treturn\n\n\tres.setHeader 'Cache-Control', 'public, max-age=0'\n\tres.setHeader 'Expires', '-1'\n\tres.setHeader 'Last-Modified', file.uploadDate?.toUTCString() or new Date().toUTCString()\n\tres.setHeader 'Content-Type', file.contentType\n\tres.setHeader 'Content-Length', file.length\n\n\tfile.readStream.pipe res\n\treturn\n"]}