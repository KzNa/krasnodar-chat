{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_oembed/server/server.coffee","meteor://ðŸ’»app/packages/rocketchat_oembed/server/providers.coffee","meteor://ðŸ’»app/packages/rocketchat_oembed/server/models/OEmbedCache.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_oembed.js","sourcesContent":["URL = Npm.require('url')\nhttp = Npm.require('http')\nhttps = Npm.require('https')\nzlib = Npm.require('zlib')\nquerystring = Npm.require('querystring')\n\ngunzipSync = Meteor.wrapAsync zlib.gunzip.bind(zlib)\ninflateSync = Meteor.wrapAsync zlib.inflate.bind(zlib)\n\nOEmbed = {}\n\ngetUrlContent = (urlObj, redirectCount = 5, callback) ->\n\tif _.isString(urlObj)\n\t\turlObj = URL.parse urlObj\n\n\topts =\n\t\tmethod: 'GET'\n\t\tport: urlObj.port\n\t\thostname: urlObj.hostname\n\t\tpath: urlObj.path\n\t\trejectUnauthorized: !RocketChat.settings.get 'Allow_Invalid_SelfSigned_Certs'\n\t\theaders:\n\t\t\t'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36'\n\n\thttpOrHttps = if urlObj.protocol is 'https:' then https else http\n\n\tparsedUrl = _.pick urlObj, ['host', 'hash', 'pathname', 'protocol', 'port', 'query', 'search']\n\n\tRocketChat.callbacks.run 'oembed:beforeGetUrlContent',\n\t\trequestOptions: opts\n\t\tparsedUrl: parsedUrl\n\n\trequest = httpOrHttps.request opts, Meteor.bindEnvironment (response) ->\n\t\tif response.statusCode in [301,302,307] and response.headers.location?\n\t\t\trequest.abort()\n\t\t\tconsole.log response.headers.location\n\n\t\t\tif redirectCount <= 0\n\t\t\t\treturn callback null, {parsedUrl: parsedUrl}\n\n\t\t\tgetUrlContent response.headers.location, --redirectCount, callback\n\t\t\treturn\n\n\t\tif response.statusCode isnt 200\n\t\t\treturn callback null, {parsedUrl: parsedUrl}\n\n\t\tchunks = []\n\t\tchunksTotalLength = 0\n\t\tresponse.on 'data', (chunk) ->\n\t\t\tchunks.push chunk\n\t\t\tchunksTotalLength += chunk.length\n\t\t\tif chunksTotalLength > 250000\n\t\t\t\trequest.abort()\n\n\t\tresponse.on 'end', Meteor.bindEnvironment ->\n\t\t\tbuffer = Buffer.concat(chunks)\n\n\t\t\ttry\n\t\t\t\tif response.headers['content-encoding'] is 'gzip'\n\t\t\t\t\tbuffer = gunzipSync buffer\n\t\t\t\telse if response.headers['content-encoding'] is 'deflate'\n\t\t\t\t\tbuffer = inflateSync buffer\n\n\t\t\tcallback null, {\n\t\t\t\theaders: response.headers\n\t\t\t\tbody: buffer.toString()\n\t\t\t\tparsedUrl: parsedUrl\n\t\t\t}\n\n\t\tresponse.on 'error', (error) ->\n\t\t\tcallback null, {\n\t\t\t\terror: error\n\t\t\t\tparsedUrl: parsedUrl\n\t\t\t}\n\n\trequest.on 'error', (error) ->\n\t\tcallback null, {\n\t\t\terror: error\n\t\t\tparsedUrl: parsedUrl\n\t\t}\n\n\trequest.end()\n\nOEmbed.getUrlMeta = (url, withFragment) ->\n\tgetUrlContentSync = Meteor.wrapAsync getUrlContent\n\n\turlObj = URL.parse url\n\n\tif withFragment?\n\t\tqueryStringObj = querystring.parse urlObj.query\n\t\tqueryStringObj._escaped_fragment_ = ''\n\t\turlObj.query = querystring.stringify queryStringObj\n\n\t\tpath = urlObj.pathname\n\t\tif urlObj.query?\n\t\t\tpath += '?' + urlObj.query\n\n\t\turlObj.path = path\n\n\tcontent = getUrlContentSync urlObj, 5\n\n\tmetas = undefined\n\n\tif content?.body?\n\t\tmetas = {}\n\t\tcontent.body.replace /<title>((.|\\n)+?)<\\/title>/gmi, (meta, title) ->\n\t\t\tmetas.pageTitle = title\n\n\t\tcontent.body.replace /<meta[^>]*(?:name|property)=[']([^']*)['][^>]*content=[']([^']*)['][^>]*>/gmi, (meta, name, value) ->\n\t\t\tmetas[changeCase.camelCase(name)] = value\n\n\t\tcontent.body.replace /<meta[^>]*(?:name|property)=[\"]([^\"]*)[\"][^>]*content=[\"]([^\"]*)[\"][^>]*>/gmi, (meta, name, value) ->\n\t\t\tmetas[changeCase.camelCase(name)] = value\n\n\t\tcontent.body.replace /<meta[^>]*content=[']([^']*)['][^>]*(?:name|property)=[']([^']*)['][^>]*>/gmi, (meta, value, name) ->\n\t\t\tmetas[changeCase.camelCase(name)] = value\n\n\t\tcontent.body.replace /<meta[^>]*content=[\"]([^\"]*)[\"][^>]*(?:name|property)=[\"]([^\"]*)[\"][^>]*>/gmi, (meta, value, name) ->\n\t\t\tmetas[changeCase.camelCase(name)] = value\n\n\n\t\tif metas.fragment is '!' and not withFragment?\n\t\t\treturn OEmbed.getUrlMeta url, true\n\n\theaders = undefined\n\n\tif content?.headers?\n\t\theaders = {}\n\t\tfor header, value of content.headers\n\t\t\theaders[changeCase.camelCase(header)] = value\n\n\tRocketChat.callbacks.run 'oembed:afterParseContent',\n\t\tmeta: metas\n\t\theaders: headers\n\t\tparsedUrl: content.parsedUrl\n\t\tcontent: content\n\n\treturn {\n\t\tmeta: metas\n\t\theaders: headers\n\t\tparsedUrl: content.parsedUrl\n\t}\n\nOEmbed.getUrlMetaWithCache = (url, withFragment) ->\n\tcache = RocketChat.models.OEmbedCache.findOneById url\n\tif cache?\n\t\treturn cache.data\n\n\tdata = OEmbed.getUrlMeta url, withFragment\n\n\tif data?\n\t\tRocketChat.models.OEmbedCache.createWithIdAndData url, data\n\n\t\treturn data\n\n\treturn\n\ngetRelevantHeaders = (headersObj) ->\n\theaders = {}\n\tfor key, value of headersObj\n\t\tif key.toLowerCase() in ['contenttype', 'contentlength'] and value?.trim() isnt ''\n\t\t\theaders[key] = value\n\n\tif Object.keys(headers).length > 0\n\t\treturn headers\n\treturn\n\ngetRelevantMetaTags = (metaObj) ->\n\ttags = {}\n\tfor key, value of metaObj\n\t\tif /^(og|fb|twitter|oembed).+|description|title|pageTitle$/.test(key.toLowerCase()) and value?.trim() isnt ''\n\t\t\ttags[key] = value\n\n\tif Object.keys(tags).length > 0\n\t\treturn tags\n\treturn\n\nOEmbed.RocketUrlParser = (message) ->\n\tif Array.isArray message.urls\n\t\tchanged = false\n\t\tfor item in message.urls\n\t\t\tdata = OEmbed.getUrlMetaWithCache item.url\n\n\t\t\tif data?\n\t\t\t\tif data.meta?\n\t\t\t\t\titem.meta = getRelevantMetaTags data.meta\n\n\t\t\t\tif data.headers?\n\t\t\t\t\titem.headers = getRelevantHeaders data.headers\n\n\t\t\t\titem.parsedUrl = data.parsedUrl\n\t\t\t\tchanged = true\n\n\t\tif changed is true\n\t\t\tRocketChat.models.Messages.setUrlsById message._id, message.urls\n\n\treturn message\n\nRocketChat.settings.get 'API_Embed', (key, value) ->\n\tif value\n\t\tRocketChat.callbacks.add 'afterSaveMessage', OEmbed.RocketUrlParser, RocketChat.callbacks.priority.LOW, 'API_Embed'\n\telse\n\t\tRocketChat.callbacks.remove 'afterSaveMessage', 'API_Embed'\n","URL = Npm.require('url')\nQueryString = Npm.require('querystring')\n\nclass Providers\n\tproviders: []\n\n\t@getConsumerUrl: (provider, url) ->\n\t\turlObj = URL.parse provider.endPoint, true\n\t\turlObj.query['url'] = url\n\t\tdelete urlObj.search\n\t\treturn URL.format urlObj\n\n\tregisterProvider: (provider) ->\n\t\tthis.providers.push(provider)\n\n\tgetProviders: () ->\n\t\treturn this.providers\n\n\tgetProviderForUrl: (url) ->\n\t\treturn _.find this.providers, (provider) ->\n\t\t\tcandidate = _.find provider.urls, (re) ->\n\t\t\t\treturn re.test url\n\t\t\treturn candidate?\n\nproviders = new Providers()\nproviders.registerProvider\n\turls: [new RegExp('https?://soundcloud.com/\\\\S+')]\n\tendPoint: 'https://soundcloud.com/oembed?format=json&maxheight=150'\nproviders.registerProvider\n\turls: [new RegExp('https?://vimeo.com/[^/]+'), new RegExp('https?://vimeo.com/channels/[^/]+/[^/]+'), new RegExp('https://vimeo.com/groups/[^/]+/videos/[^/]+')]\n\tendPoint: 'https://vimeo.com/api/oembed.json?maxheight=200'\nproviders.registerProvider\n\turls: [new RegExp('https?://www.youtube.com/\\\\S+'), new RegExp('https?://www.youtu.be/\\\\S+')]\n\tendPoint: 'https://www.youtube.com/oembed?maxheight=200'\nproviders.registerProvider\n\turls: [new RegExp('https?://www.rdio.com/\\\\S+'), new RegExp('https?://rd.io/\\\\S+')]\n\tendPoint: 'https://www.rdio.com/api/oembed/?format=json&maxheight=150'\nproviders.registerProvider\n\turls: [new RegExp('https?://www.slideshare.net/[^/]+/[^/]+')]\n\tendPoint: 'https://www.slideshare.net/api/oembed/2?format=json&maxheight=200'\nproviders.registerProvider\n\turls: [new RegExp('https?://www.dailymotion.com/video/\\\\S+')]\n\tendPoint: 'https://www.dailymotion.com/services/oembed?maxheight=200'\n\nRocketChat.oembed = {}\nRocketChat.oembed.providers = providers\n\nRocketChat.callbacks.add 'oembed:beforeGetUrlContent', (data) ->\n\tif data.parsedUrl?\n\t\turl = URL.format data.parsedUrl\n\t\tprovider = providers.getProviderForUrl url\n\t\tif provider?\n\t\t\tconsumerUrl = Providers.getConsumerUrl provider, url\n\t\t\tconsumerUrl = URL.parse consumerUrl, true\n\t\t\t_.extend data.parsedUrl, consumerUrl\n\t\t\tdata.requestOptions.port = consumerUrl.port\n\t\t\tdata.requestOptions.hostname = consumerUrl.hostname\n\t\t\tdata.requestOptions.path = consumerUrl.path\n\nRocketChat.callbacks.add 'oembed:afterParseContent', (data) ->\n\tif data.parsedUrl?.query?\n\t\tqueryString = data.parsedUrl.query\n\t\tif _.isString data.parsedUrl.query\n\t\t\tqueryString = QueryString.parse data.parsedUrl.query\n\t\tif queryString.url?\n\t\t\turl = queryString.url\n\t\t\tprovider = providers.getProviderForUrl url\n\t\t\tif provider?\n\t\t\t\tif data.content?.body?\n\t\t\t\t\tmetas = JSON.parse data.content.body;\n\t\t\t\t\t_.each metas, (value, key) ->\n\t\t\t\t\t\tif _.isString value\n\t\t\t\t\t\t\tdata.meta[changeCase.camelCase('oembed_' + key)] = value\n\t\t\t\t\tdata.meta['oembedUrl'] = url\n","RocketChat.models.OEmbedCache = new class extends RocketChat.models._Base\n\tconstructor: ->\n\t\t@_initModel 'oembed_cache'\n\n\n\t# FIND ONE\n\tfindOneById: (_id, options) ->\n\t\tquery =\n\t\t\t_id: _id\n\n\t\treturn @findOne query, options\n\n\n\t# INSERT\n\tcreateWithIdAndData: (_id, data) ->\n\t\trecord =\n\t\t\t_id: _id\n\t\t\tdata: data\n\t\t\tupdatedAt: new Date\n\n\t\trecord._id = @insert record\n\t\treturn record\n"]}